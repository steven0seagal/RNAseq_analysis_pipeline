/*
========================================================================================
    Module-specific Configuration
========================================================================================
    Configuration for individual processes/modules
----------------------------------------------------------------------------------------
*/

process {

    // ===== FASTQC =====
    withName: 'FASTQC' {
        ext.args = '--quiet'
        publishDir = [
            path: { "${params.outdir}/fastqc" },
            mode: params.publish_dir_mode,
            pattern: "*.{html,zip}"
        ]
    }

    // ===== FASTP =====
    withName: 'FASTP' {
        ext.args = [
            "--cut_front",
            "--cut_tail",
            "--cut_window_size 4",
            "--cut_mean_quality ${params.quality_cutoff}",
            "--qualified_quality_phred ${params.quality_cutoff}",
            "--unqualified_percent_limit 10",
            "--length_required ${params.min_trimmed_length}"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/fastp" },
                mode: params.publish_dir_mode,
                pattern: "*.{html,json}"
            ],
            [
                path: { "${params.outdir}/fastp/log" },
                mode: params.publish_dir_mode,
                pattern: "*.log"
            ]
        ]
    }

    // ===== STAR INDEX =====
    withName: 'STAR_GENOMEGENERATE' {
        ext.args = [
            "--genomeSAindexNbases 14",
            "--genomeChrBinNbits 18"
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/genome" },
            mode: params.publish_dir_mode,
            enabled: false
        ]
    }

    // ===== STAR ALIGN =====
    withName: 'STAR_ALIGN' {
        ext.args = [
            "--outSAMtype BAM SortedByCoordinate",
            "--outSAMunmapped Within",
            "--outSAMattributes Standard",
            "--outFilterType BySJout",
            "--outFilterMultimapNmax 20",
            "--alignSJoverhangMin 8",
            "--alignSJDBoverhangMin 1",
            "--outFilterMismatchNmax 999",
            "--outFilterMismatchNoverReadLmax 0.04",
            "--alignIntronMin 20",
            "--alignIntronMax 1000000",
            "--alignMatesGapMax 1000000"
        ].join(' ').trim()
        publishDir = [
            [
                path: { "${params.outdir}/star" },
                mode: params.publish_dir_mode,
                pattern: "*.bam"
            ],
            [
                path: { "${params.outdir}/star/log" },
                mode: params.publish_dir_mode,
                pattern: "*Log.final.out"
            ]
        ]
    }

    // ===== SAMTOOLS INDEX =====
    withName: 'SAMTOOLS_INDEX' {
        publishDir = [
            path: { "${params.outdir}/star" },
            mode: params.publish_dir_mode,
            pattern: "*.bai"
        ]
    }

    // ===== FEATURECOUNTS =====
    withName: 'SUBREAD_FEATURECOUNTS' {
        ext.args = [
            "-t ${params.feature_type}",
            "-g ${params.gene_attribute}",
            "-s ${params.strand_specificity}",
            "-p",
            "-B",
            "-C"
        ].join(' ').trim()
        publishDir = [
            path: { "${params.outdir}/featurecounts" },
            mode: params.publish_dir_mode,
            pattern: "*.{tsv,txt,summary}"
        ]
    }

    // ===== MULTIQC =====
    withName: 'MULTIQC' {
        ext.args   = params.multiqc_title ? "--title \"${params.multiqc_title}\"" : ''
        publishDir = [
            path: { "${params.outdir}/multiqc" },
            mode: params.publish_dir_mode,
            pattern: "*.html"
        ]
    }

    // ===== BWA INDEX (for circRNA) =====
    withName: 'BWA_INDEX' {
        publishDir = [
            path: { "${params.outdir}/genome" },
            mode: params.publish_dir_mode,
            enabled: false
        ]
    }

    // ===== BWA MEM (for circRNA) =====
    withName: 'BWA_MEM' {
        ext.args = "-T 19"
        publishDir = [
            path: { "${params.outdir}/bwa_mem" },
            mode: params.publish_dir_mode,
            pattern: "*.bam"
        ]
    }

    // ===== GATK4 PROCESSES =====
    withName: 'GATK4_ADDORREPLACEREADGROUPS' {
        ext.args = [
            "--SORT_ORDER coordinate",
            "--VALIDATION_STRINGENCY LENIENT"
        ].join(' ')
    }

    withName: 'GATK4_MARKDUPLICATES' {
        ext.args = [
            "--VALIDATION_STRINGENCY LENIENT",
            "--OPTICAL_DUPLICATE_PIXEL_DISTANCE 2500",
            "--ASSUME_SORT_ORDER coordinate"
        ].join(' ')
    }

    withName: 'GATK4_SPLITNCIGARREADS' {
        ext.args = [
            "--refactor-NDN-cigar-string",
            "--skip-mapping-quality-transform"
        ].join(' ')
    }

    withName: 'GATK4_MUTECT2' {
        ext.args = [
            "--disable-read-filter MateOnSameContigOrNoMappedMateReadFilter",
            "--max-reads-per-alignment-start 0",
            "--dont-use-soft-clipped-bases"
        ].join(' ')
    }

    // ===== SALMON =====
    withName: 'SALMON_INDEX' {
        publishDir = [
            path: { "${params.outdir}/genome" },
            mode: params.publish_dir_mode,
            enabled: false
        ]
    }

    withName: 'SALMON_QUANT' {
        ext.args = "--validateMappings --gcBias --seqBias"
        publishDir = [
            path: { "${params.outdir}/salmon" },
            mode: params.publish_dir_mode
        ]
    }

    // ===== DESEQ2 ANALYSIS =====
    withName: 'DESEQ2_ANALYSIS' {
        ext.args = [
            "--padj_threshold ${params.padj_threshold}",
            "--log2fc_threshold ${params.log2fc_threshold}"
        ].join(' ')
        publishDir = [
            path: { "${params.outdir}/deseq2" },
            mode: params.publish_dir_mode
        ]
    }
}
